version: "3.3"

services:
  app:
    image: elestio4test/castopodapp:latest
    user: 0:0
    volumes:
      - castopod-media:/opt/castopod/public/media
      - ./data:/castopod
    environment:
      MYSQL_DATABASE: castopod
      MYSQL_USER: castopod
      MYSQL_PASSWORD: changeme
      CP_BASEURL: "https://${BASE_URL}"
      CP_ANALYTICS_SALT: changeme
      CP_CACHE_HANDLER: redis
      CP_REDIS_HOST: redis
      CP_EMAIL_SMTP_HOST: ${CP_EMAIL_SMTP_HOST}
      CP_EMAIL_FROM: ${CP_EMAIL_FROM}
      CP_EMAIL_SMTP_USERNAME: ${CP_EMAIL_SMTP_USERNAME}
      CP_EMAIL_SMTP_PASSWORD: ${CP_EMAIL_SMTP_PASSWORD}
      CP_EMAIL_SMTP_PORT: ${CP_EMAIL_SMTP_PORT}
      CP_EMAIL_SMTP_CRYPTO: ${CP_EMAIL_SMTP_CRYPTO}
    restart: always

  web-server:
    image: castopod/web-server:latest
    volumes:
      - castopod-media:/var/www/html/media
    ports:
      - 172.17.0.1:8989:80
    restart: always

  mysqldb:
    image: elestio/mysql:latest
    volumes:
      - ./castopod-db:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: changeme
      MYSQL_DATABASE: castopod
      MYSQL_USER: castopod
      MYSQL_PASSWORD: changeme
    restart: always

  redis:
    image: redis:7.0-alpine
    volumes:
      - ./castopod-cache:/data

  # this container is optional
  # add this if you want to use the videoclips feature
  # ffmpeg:
  #   image: castopod/video-clipper:latest
  #   volumes:
  #     - ./castopod-media:/opt/castopod/public/media
  #   environment:
  #     MYSQL_DATABASE: castopod
  #     MYSQL_USER: castopod
  #     MYSQL_PASSWORD: changeme
  #   restart: always

volumes:
  castopod-media:
    driver: local
    driver_opts:
     type: none
     device: ${PWD}/data
     o: bind

